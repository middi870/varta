<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profile Dashboard</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.dashboard-container {
    background: white;
    border-radius: 20px;
    width: 100%;
    max-width: 600px;
    padding: 40px;
    box-shadow: 0 20px 30px rgba(0,0,0,0.15);
    animation: fadeIn 0.6s ease-out;
    text-align: center;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

.header h1 {
    font-size: 32px;
    color: #1f2937;
    margin-bottom: 8px;
}

.header p {
    font-size: 16px;
    color: #6b7280;
}

.welcome-message {
    background: linear-gradient(90deg, #667eea, #764ba2);
    color: white;
    padding: 20px;
    border-radius: 16px;
    margin: 20px 0;
    font-size: 18px;
    font-weight: 600;
    box-shadow: 0 8px 15px rgba(0,0,0,0.1);
}

.error-message {
    color: #ef4444;
    margin-bottom: 12px;
    display: none;
    font-weight: 500;
}

.profile-card {
    background: #f3f4f6;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    display: inline-block;
    text-align: left;
}

.profile-card img {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    margin-bottom: 15px;
    display: block;
    margin-left: auto;
    margin-right: auto;
}

.profile-card p {
    margin: 10px 0;
    font-size: 16px;
    color: #374151;
    word-break: break-word;
}

.profile-card p strong {
    color: #1f2937;
}

.logout-btn {
    display: block;
    width: 100%;
    background: #ef4444;
    color: white;
    padding: 14px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.logout-btn:hover {
    background: #dc2626;
    transform: translateY(-2px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.1);
}

@media (max-width: 480px) {
    .dashboard-container {
        padding: 20px;
    }

    .header h1 {
        font-size: 26px;
    }

    .welcome-message {
        font-size: 16px;
        padding: 16px;
    }
}
</style>
</head>
<body>

<div class="dashboard-container">
    <div class="header">
        <h1><i class="fas fa-user-circle"></i> My Profile</h1>
        <p>Welcome to your dashboard</p>
    </div>

    <div class="welcome-message" id="welcomeMessage">
        Loading...
    </div>

    <div class="error-message" id="errorMessage"></div>

    <div class="profile-card" id="profileInfo" style="display:none;">
        <img id="avatar" src="" alt="Avatar">
        <p><strong>ID:</strong> <span id="userId"></span></p>
        <p><strong>Username:</strong> <span id="username"></span></p>
        <p><strong>Email:</strong> <span id="email"></span></p>
        <p><strong>Created At:</strong> <span id="createdAt"></span></p>
    </div>

    <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
</div>

<!-- MD5 for Gravatar hashing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>
<script>
const API = "https://k12-backend-y0uj.onrender.com";

async function fetchProfile() {
    const token = localStorage.getItem('k12_token');

    if (!token) {
        showError("You are not logged in. Redirecting to login...");
        setTimeout(() => window.location.href = "../auth.html", 1500);
        return;
    }

    try {
        const res = await fetch(`${API}/profile`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) {
            if (res.status === 401 || res.status === 403) {
                showError("Session expired. Redirecting to login...");
                localStorage.removeItem('k12_token');
                setTimeout(() => window.location.href = "../auth.html", 1500);
            } else {
                showError("Unable to fetch profile.");
            }
            return;
        }

        const data = await res.json();

        if (data.user) {
            const user = data.user;
            document.getElementById('userId').innerText = user.id;
            document.getElementById('username').innerText = user.username;
            document.getElementById('email').innerText = user.email || 'N/A';
            document.getElementById('createdAt').innerText = new Date(user.created_at).toLocaleString();
            document.getElementById('welcomeMessage').innerText = `Welcome, ${user.username}!`;
            document.getElementById('profileInfo').style.display = 'block';

            if (user.email) {
                const hash = md5(user.email.trim().toLowerCase());
                document.getElementById('avatar').src = `https://www.gravatar.com/avatar/${hash}?s=200&d=identicon`;
            } else {
                document.getElementById('avatar').src = `https://ui-avatars.com/api/?name=${user.username}&size=200`;
            }
        } else {
            showError(data.message || "Unable to fetch profile");
        }
    } catch (err) {
        console.error(err);
        showError("Server error. Try again later.");
    }
}

function showError(msg) {
    const errorEl = document.getElementById('errorMessage');
    errorEl.innerText = msg;
    errorEl.style.display = 'block';
}

// Logout
document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('k12_token');
    window.location.href = "../auth.html";
});

// Only call fetchProfile once
document.addEventListener('DOMContentLoaded', fetchProfile);
</script>
</body>
</html>

